# 04 - 技术架构

**版本**: v1.0.0  
**最后更新**: 2024

---

## 1. 技术栈

### 1.1 核心技术

| 技术 | 版本 | 用途 |
|-----|------|------|
| Plasmo Framework | 0.90.5 | Chrome扩展开发框架 |
| React | 18.2.0 | UI库 |
| TypeScript | 5.3.3 | 类型系统 |
| Tailwind CSS | 3.x | 样式框架 |

### 1.2 辅助库

| 库 | 用途 |
|----|------|
| Day.js | 时间处理 |
| canvas-confetti | 礼花效果 |
| Recharts | 图表展示 |
| Lucide React | 图标库 |
| Headless UI | 对话框组件 |

---

## 2. 系统架构

### 2.1 架构图

```
┌─────────────────────────────────────────────┐
│             Chrome Browser                  │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │   Background Service Worker         │  │
│  │   - 时间管理核心                     │  │
│  │   - 状态管理                         │  │
│  │   - Tab监听                          │  │
│  │   - 定时任务                         │  │
│  └──────────┬──────────────────────────┘  │
│             │ chrome.runtime.sendMessage   │
│  ┌──────────┴──────────────────────────┐  │
│  │   Content Scripts (注入到页面)      │  │
│  │   ├─ timer-overlay.tsx               │  │
│  │   └─ pending-lock-overlay.tsx        │  │
│  └──────────┬──────────────────────────┘  │
│             │                               │
│  ┌──────────┴──────────────────────────┐  │
│  │   UI Pages                           │  │
│  │   ├─ popup.tsx                       │  │
│  │   ├─ options.tsx                     │  │
│  │   └─ tabs/blocked.tsx                │  │
│  └─────────────────────────────────────┘  │
│                                             │
│  ┌─────────────────────────────────────┐  │
│  │   chrome.storage.local               │  │
│  │   - WebsiteConfig[]                  │  │
│  │   - UsageData[]                      │  │
│  │   - GlobalSettings                   │  │
│  └─────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### 2.2 模块职责

#### Background Service Worker
**核心职责**：
- 监听Tab激活/切换事件
- 管理三状态（Active/Pending/Locked）
- 时间计算和同步
- 定时任务（每日重置）
- 固定时间锁定检测
- 消息通信中心

**关键API**：
```typescript
chrome.tabs.onActivated
chrome.tabs.onUpdated
chrome.alarms
chrome.storage.local
chrome.runtime.sendMessage
```

#### Content Script
**核心职责**：
- 注入倒计时悬浮窗
- 注入待锁定状态遮罩
- 接收Background消息
- DOM操作

**注入时机**：
- 匹配受限网站时自动注入
- 使用 `matches` 配置

#### UI Pages
**核心职责**：
- Popup: 快速概览
- Options: 完整配置
- Blocked: 阻止页面

---

## 3. 文件组织

### 3.1 目录结构

```
/Users/paraslee/Documents/block-website/test/
├── docs/                            # 产品文档
├── popup.tsx                        # Popup页面
├── options.tsx                      # Options页面
├── contents/
│   ├── timer-overlay.tsx            # 倒计时悬浮窗
│   └── pending-lock-overlay.tsx     # 待锁定遮罩
├── background/
│   └── index.ts                     # Background Service
├── tabs/
│   └── blocked.tsx                  # 阻止页面
├── components/                      # 共享组件
├── hooks/                           # 自定义Hooks
├── utils/                           # 工具函数
├── types/                           # 类型定义
├── styles/                          # 样式文件
├── tailwind.config.js               # Tailwind配置
├── tsconfig.json                    # TS配置
└── package.json                     # 依赖管理
```

---

## 4. 数据流

### 4.1 时间计数流程

```
Tab激活
    ↓
Background监听到事件
    ↓
检查域名是否受限
    ↓
如果受限 → 开始计时
    ↓
每秒更新usedTime
    ↓
保存到chrome.storage.local
    ↓
通知Content Script更新UI
    ↓
Content Script更新悬浮窗显示
```

### 4.2 状态同步流程

```
Background状态变化
    ↓
保存到chrome.storage.local
    ↓
触发chrome.storage.onChanged事件
    ↓
所有监听的页面/脚本收到通知
    ↓
更新各自的UI状态
```

---

## 5. 关键技术实现

### 5.1 三状态管理

```typescript
type Status = 'active' | 'pending' | 'locked';

interface UsageData {
  status: Status;
  // ...
}

// 状态转换
function transitionState(
  from: Status,
  to: Status,
  reason: string
) {
  // 验证转换合法性
  // 更新状态
  // 触发相应操作
}
```

### 5.2 跨Tab时间同步

```typescript
// Background
chrome.tabs.onActivated.addListener((activeInfo) => {
  const { tabId } = activeInfo;
  
  // 暂停之前活跃tab的计时
  if (currentActiveTab) {
    pauseTimer(currentActiveTab);
  }
  
  // 开始新tab的计时
  currentActiveTab = tabId;
  startTimer(tabId);
});
```

### 5.3 毛玻璃效果

```css
.glassmorphism {
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}
```

### 5.4 单词验证

```typescript
function validateWordInput(
  generated: string,
  userInput: string
): boolean {
  return generated === userInput; // 完全匹配
}
```

---

## 6. 性能优化

### 6.1 Content Script优化
- 按需注入
- 使用虚拟DOM最小化重渲染
- 防抖/节流处理高频事件

### 6.2 Background优化
- 避免长时间运行的任务
- 使用chrome.alarms替代setInterval
- 及时清理不用的数据

### 6.3 存储优化
- 分批读写
- 使用索引加快查询
- 定期清理过期数据

---

## 7. 安全性

### 7.1 数据安全
- 所有数据本地存储
- 不上传任何用户数据
- 导入时验证数据完整性

### 7.2 权限最小化
- 只申请必需权限
- 明确告知用户权限用途

---

**文档版本**: v1.0.0  
**维护者**: ParaSLee  
**最后更新**: 2024
