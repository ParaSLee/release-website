# 08 - 重启机制

**版本**: v1.0.0  
**最后更新**: 2024

---

## 1. 重启机制概述

重启机制是本插件的核心创新功能，通过多层验证在"灵活性"和"坚定性"之间找到平衡。

### 1.1 设计理念

**为什么需要重启功能？**
- 紧急情况下需要访问被锁定的网站
- 完全禁止访问会导致用户卸载插件
- 需要提供"后悔药"但增加使用难度

**如何平衡灵活与坚定？**
- **灵活性**：提供重启选项
- **坚定性**：通过多层验证增加重启难度
- **激励性**：取消重启也给予正向反馈

---

## 2. 三层验证设计

### 2.1 第一层：重启按钮

**位置**：阻止页面  
**作用**：入口，让用户明确知道可以重启

**设计要点**：
- 按钮不过于显眼（避免诱导点击）
- 但也不隐藏（保持透明）
- 位置：页面底部中央

### 2.2 第二层：警告与选择

**第一个弹窗内容**：
1. **警告标题**："警告：请坚持自律"
2. **励志语句**：随机显示
3. **三个按钮**：
   - 确定重启（10秒倒计时）
   - 紧急重启（每日一次）
   - 取消重启

**设计要点**：
- **10秒倒计时**：给用户冷静思考的时间
- **紧急重启**：快速通道但有全局限制
- **取消按钮**：给予礼花效果正向反馈

### 2.3 第三层：单词验证

**第二个弹窗内容**：
1. **120个随机单词**：来自预设词库
2. **输入框**：用户必须完全匹配输入
3. **实时验证**：显示匹配度
4. **两个按钮**：
   - 确定（只有匹配时可点击）
   - 取消（礼花效果）

**设计要点**：
- **120个单词**：足够的难度（约需3-5分钟）
- **完全匹配**：大小写、空格、标点必须一致
- **过程中反思**：输入过程让用户重新思考

---

## 3. 紧急重启机制

### 3.1 紧急重启特性

**限制**：
- 每天只能使用1次
- **全局共享**：任意网址使用后，其他网址也无法使用

**实现**：
```typescript
interface GlobalSettings {
  emergencyRestartUsedToday: boolean;
  emergencyRestartUsedDate: string;
}

function canUseEmergencyRestart(): boolean {
  const today = formatDate(new Date());
  return !settings.emergencyRestartUsedToday || 
         settings.emergencyRestartUsedDate !== today;
}
```

### 3.2 紧急重启流程

```
用户点击"紧急重启"
      ↓
检查今日是否已使用
      ↓
    是 / 否
    ↓     ↓
  提示    立即重启
  已使用      ↓
          标记为已使用
              ↓
          返回Active状态
```

---

## 4. 确定重启机制

### 4.1 确定重启流程

```
用户点击"确定重启"
      ↓
等待10秒倒计时
      ↓
10秒结束，按钮可点击
      ↓
用户点击"确定重启"
      ↓
显示第二个弹窗
      ↓
显示120个随机单词
      ↓
用户输入
      ↓
实时验证匹配度
      ↓
完全匹配后，确定按钮可点击
      ↓
用户点击"确定"
      ↓
执行重启
```

### 4.2 单词生成器

**词库**：
- 1000+常用英文单词
- 简单易拼写
- 避免生僻词

**生成逻辑**：
```typescript
function generateWords(count: number = 120): string {
  const words: string[] = [];
  const wordBank = COMMON_WORDS; // 1000+单词
  
  for (let i = 0; i < count; i++) {
    const randomIndex = Math.floor(Math.random() * wordBank.length);
    words.push(wordBank[randomIndex]);
  }
  
  return words.join(' ');
}
```

**格式化输出**：
```
每行10个单词，共12行
apple orange banana grape fruit computer keyboard mouse screen window
door table chair desk lamp book pen paper pencil eraser
...
```

### 4.3 输入验证

```typescript
function validateInput(generated: string, userInput: string): boolean {
  // 完全匹配：大小写、空格、标点
  return generated === userInput;
}

function getMatchPercentage(generated: string, userInput: string): number {
  const genWords = generated.split(' ');
  const userWords = userInput.split(' ');
  
  let matches = 0;
  for (let i = 0; i < Math.min(genWords.length, userWords.length); i++) {
    if (genWords[i] === userWords[i]) {
      matches++;
    }
  }
  
  return Math.round((matches / genWords.length) * 100);
}
```

---

## 5. 重启执行逻辑

### 5.1 重启操作

```typescript
async function restartWebsite(domain: string) {
  const usageData = await getTodayUsage(domain);
  const website = await getWebsite(domain);
  
  // 重置时间
  usageData.usedTime = 0;
  usageData.status = 'active';
  usageData.restarted = true;
  usageData.restartedAt = Date.now();
  
  // 如果在固定时间锁定期间重启
  if (isInTimeLockPeriod(domain)) {
    usageData.timeLockDisabled = true;
  }
  
  // 保存数据
  await saveUsageData(usageData);
  
  // 跳转回原网站
  chrome.tabs.update({ url: `https://${domain}` });
}
```

### 5.2 固定时间锁定禁用

**逻辑**：
- 重启后，该网址的固定时间锁定临时禁用
- 只关注倒计时时间
- 禁用效果持续到该网址再次被锁定

**实现**：
```typescript
function shouldBlockForTimeLock(domain: string): boolean {
  const usageData = getTodayUsage(domain);
  
  // 如果已被禁用，跳过固定时间锁定检测
  if (usageData.timeLockDisabled) {
    return false;
  }
  
  return isInTimeLockPeriod(domain);
}
```

---

## 6. 网址隔离

### 6.1 隔离原则

- **重启操作**：每个网址独立，互不影响
- **紧急重启**：全局共享，一天只能用一次

**示例**：
- 用户重启了YouTube，不影响Twitter的状态
- 但用户使用了紧急重启在YouTube，就无法在Twitter再使用紧急重启

### 6.2 实现

```typescript
interface UsageData {
  domain: string;        // 网址级别
  restarted: boolean;    // 网址级别
  timeLockDisabled: boolean; // 网址级别
}

interface GlobalSettings {
  emergencyRestartUsedToday: boolean; // 全局级别
}
```

---

## 7. 礼花效果

### 7.1 触发时机

**两个时机**：
1. 第一个弹窗点击"取消重启"
2. 第二个弹窗点击"取消"

### 7.2 实现

```typescript
import confetti from 'canvas-confetti';

function showConfetti() {
  confetti({
    particleCount: 100,
    spread: 70,
    origin: { y: 0.6 },
    colors: ['#3B82F6', '#10B981', '#F59E0B']
  });
  
  // 显示祝贺文案
  showMessage('恭喜你的坚持！');
}
```

### 7.3 设计意义

- **正向强化**：即使取消也给予鼓励
- **心理满足**：让用户感受到坚持的价值
- **降低挫败感**：不会让用户觉得"什么都做不了"

---

## 8. 重启历史记录

### 8.1 记录内容

```typescript
interface UsageData {
  restarted: boolean;      // 今日是否重启过
  restartedAt?: number;    // 最后重启时间
}
```

### 8.2 UI显示

**Popup和Options中**：
- 显示"已重启"徽章
- 鼠标悬停显示重启时间
- 提醒用户珍惜重启机会

---

## 9. 设计考量

### 9.1 为什么是120个单词？

**考虑因素**：
- **时间成本**：需要3-5分钟输入
- **不过分**：不至于让用户完全放弃
- **有效性**：足够让用户重新思考

**备选方案**：
- v1.1.0可能提供60/120/200三个难度选项

### 9.2 为什么是10秒倒计时？

**考虑因素**：
- **冷静时间**：足够让用户重新思考
- **不拖延**：不会太长导致用户不耐烦
- **心理学**：10秒是合适的"暂停"时长

### 9.3 为什么需要礼花效果？

**考虑因素**：
- **正向激励**：让坚持变得值得庆祝
- **情感连接**：建立用户与产品的情感纽带
- **降低抵触**：减少用户对"限制"的负面情绪

---

**文档版本**: v1.0.0  
**维护者**: ParaSLee  
**最后更新**: 2024
