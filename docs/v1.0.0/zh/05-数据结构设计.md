# 05 - 数据结构设计

**版本**: v1.0.0  
**最后更新**: 2024

---

## 1. 核心数据结构

### 1.1 WebsiteConfig - 网站配置

```typescript
interface WebsiteConfig {
  id: string;                  // 唯一标识 (UUID)
  domain: string;              // 域名 (如 youtube.com)
  displayName: string;         // 显示名称
  dailyLimit: number;          // 每日限制时间（秒）
  enabled: boolean;            // 是否启用
  icon?: string;               // 网站图标 (URL或base64)
  createdAt: number;           // 创建时间戳
}
```

**示例**：
```json
{
  "id": "uuid-123-456",
  "domain": "youtube.com",
  "displayName": "YouTube",
  "dailyLimit": 3600,
  "enabled": true,
  "icon": "https://...",
  "createdAt": 1704067200000
}
```

### 1.2 UsageData - 使用数据

```typescript
interface UsageData {
  domain: string;              // 域名
  date: string;                // 日期 (YYYY-MM-DD)
  usedTime: number;            // 已使用时间（秒）
  startTime?: number;          // 当前会话开始时间戳
  activeTabId?: number;        // 当前活跃的tab ID
  lastUpdate: number;          // 最后更新时间戳
  status: 'active' | 'pending' | 'locked';  // 状态
  pendingStartTime?: number;   // 进入待锁定状态的时间戳
  emergencyUsedToday: number;  // 今日紧急使用次数
  restarted: boolean;          // 今日是否被重启过
  restartedAt?: number;        // 最后重启时间戳
  timeLockDisabled: boolean;   // 固定时间锁定是否被禁用
}
```

**示例**：
```json
{
  "domain": "youtube.com",
  "date": "2024-01-01",
  "usedTime": 2400,
  "startTime": 1704070800000,
  "activeTabId": 123,
  "lastUpdate": 1704070900000,
  "status": "active",
  "emergencyUsedToday": 2,
  "restarted": false,
  "timeLockDisabled": false
}
```

### 1.3 TimeLockPeriod - 时间锁定段

```typescript
interface TimeLockPeriod {
  id: string;                  // 唯一标识
  startTime: string;           // 开始时间 (HH:mm)
  endTime: string;             // 结束时间 (HH:mm)
  enabled: boolean;            // 是否启用
  label?: string;              // 标签 (如"睡眠时间")
}
```

**示例**：
```json
{
  "id": "period-1",
  "startTime": "22:00",
  "endTime": "06:00",
  "enabled": true,
  "label": "睡眠时间"
}
```

### 1.4 TimeLockSettings - 固定时间锁定设置

```typescript
interface TimeLockSettings {
  enabled: boolean;            // 总开关
  mode: 'restricted' | 'all';  // restricted=仅限制清单 all=所有HTTP/HTTPS
  periods: TimeLockPeriod[];   // 锁定时间段列表
}
```

**示例**：
```json
{
  "enabled": true,
  "mode": "restricted",
  "periods": [
    {
      "id": "period-1",
      "startTime": "22:00",
      "endTime": "06:00",
      "enabled": true,
      "label": "睡眠时间"
    }
  ]
}
```

### 1.5 GlobalSettings - 全局设置

```typescript
interface GlobalSettings {
  resetTime: string;           // 重置时间点 (HH:mm)
  floatingPosition: {          // 悬浮窗位置
    x: number;
    y: number;
  };
  isCollapsed: boolean;        // 是否收起
  emergencyExtraTime: number;  // 紧急使用额外时间（秒）
  pendingLockDuration: number; // 待锁定缓冲时间（秒）
  emergencyRestartUsedToday: boolean;  // 今日紧急重启是否已使用
  emergencyRestartUsedDate: string;    // 紧急重启使用日期
}
```

**示例**：
```json
{
  "resetTime": "06:00",
  "floatingPosition": {
    "x": 20,
    "y": 20
  },
  "isCollapsed": false,
  "emergencyExtraTime": 600,
  "pendingLockDuration": 30,
  "emergencyRestartUsedToday": false,
  "emergencyRestartUsedDate": "2024-01-01"
}
```

---

## 2. 存储方案

### 2.1 Chrome Storage 结构

```typescript
interface StorageSchema {
  // 网站配置列表
  websites: WebsiteConfig[];
  
  // 使用数据列表
  usageData: UsageData[];
  
  // 固定时间锁定设置
  timeLockSettings: TimeLockSettings;
  
  // 全局设置
  globalSettings: GlobalSettings;
}
```

### 2.2 存储API封装

```typescript
// hooks/useStorage.ts
export function useStorage<T>(key: string) {
  const [value, setValue] = useState<T | null>(null);
  
  useEffect(() => {
    chrome.storage.local.get(key, (result) => {
      setValue(result[key]);
    });
    
    const listener = (changes: any) => {
      if (changes[key]) {
        setValue(changes[key].newValue);
      }
    };
    
    chrome.storage.onChanged.addListener(listener);
    return () => chrome.storage.onChanged.removeListener(listener);
  }, [key]);
  
  const updateValue = useCallback((newValue: T) => {
    chrome.storage.local.set({ [key]: newValue });
  }, [key]);
  
  return [value, updateValue] as const;
}
```

---

## 3. 数据操作

### 3.1 CRUD操作

#### 添加网站
```typescript
async function addWebsite(config: Omit<WebsiteConfig, 'id' | 'createdAt'>) {
  const websites = await getWebsites();
  const newWebsite: WebsiteConfig = {
    ...config,
    id: generateUUID(),
    createdAt: Date.now()
  };
  websites.push(newWebsite);
  await saveWebsites(websites);
}
```

#### 更新网站
```typescript
async function updateWebsite(id: string, updates: Partial<WebsiteConfig>) {
  const websites = await getWebsites();
  const index = websites.findIndex(w => w.id === id);
  if (index !== -1) {
    websites[index] = { ...websites[index], ...updates };
    await saveWebsites(websites);
  }
}
```

#### 删除网站
```typescript
async function deleteWebsite(id: string) {
  const websites = await getWebsites();
  const filtered = websites.filter(w => w.id !== id);
  await saveWebsites(filtered);
}
```

### 3.2 使用数据查询

#### 获取今日使用数据
```typescript
async function getTodayUsage(domain: string): Promise<UsageData | null> {
  const today = formatDate(new Date());
  const usageData = await getAllUsageData();
  return usageData.find(d => d.domain === domain && d.date === today) || null;
}
```

#### 获取本周统计
```typescript
async function getWeeklyStats(domain: string) {
  const usageData = await getAllUsageData();
  const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
  
  return usageData
    .filter(d => d.domain === domain && new Date(d.date).getTime() >= weekAgo)
    .reduce((total, d) => total + d.usedTime, 0);
}
```

---

## 4. 数据迁移

### 4.1 版本升级迁移

```typescript
async function migrateData(fromVersion: string, toVersion: string) {
  if (fromVersion === '0.9.0' && toVersion === '1.0.0') {
    // 添加新字段
    const usageData = await getAllUsageData();
    usageData.forEach(data => {
      if (!data.hasOwnProperty('restarted')) {
        data.restarted = false;
      }
      if (!data.hasOwnProperty('timeLockDisabled')) {
        data.timeLockDisabled = false;
      }
    });
    await saveAllUsageData(usageData);
  }
}
```

### 4.2 数据导入/导出

#### 导出
```typescript
async function exportData(): Promise<string> {
  const data = {
    websites: await getWebsites(),
    timeLockSettings: await getTimeLockSettings(),
    globalSettings: await getGlobalSettings(),
    version: '1.0.0',
    exportedAt: Date.now()
  };
  return JSON.stringify(data, null, 2);
}
```

#### 导入
```typescript
async function importData(jsonString: string) {
  const data = JSON.parse(jsonString);
  
  // 验证数据结构
  validateImportData(data);
  
  // 导入数据
  await saveWebsites(data.websites);
  await saveTimeLockSettings(data.timeLockSettings);
  await saveGlobalSettings(data.globalSettings);
}
```

---

## 5. 数据清理

### 5.1 清理过期数据

```typescript
async function cleanupOldData() {
  const usageData = await getAllUsageData();
  const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
  
  const filtered = usageData.filter(d => {
    const dateTime = new Date(d.date).getTime();
    return dateTime >= thirtyDaysAgo;
  });
  
  await saveAllUsageData(filtered);
}
```

### 5.2 每日重置

```typescript
async function dailyReset() {
  const usageData = await getAllUsageData();
  const today = formatDate(new Date());
  
  // 重置今日数据
  usageData.forEach(data => {
    if (data.date === today) {
      data.usedTime = 0;
      data.status = 'active';
      data.restarted = false;
      data.emergencyUsedToday = 0;
      data.timeLockDisabled = false;
    }
  });
  
  // 重置紧急重启状态
  const settings = await getGlobalSettings();
  settings.emergencyRestartUsedToday = false;
  settings.emergencyRestartUsedDate = today;
  
  await saveAllUsageData(usageData);
  await saveGlobalSettings(settings);
}
```

---

**文档版本**: v1.0.0  
**维护者**: ParaSLee  
**最后更新**: 2024
